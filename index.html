<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Wani4ka Lands</title>

</head>
<script src="/storage/js/pixi.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<body>
<div id="game" style="position:absolute; width:765px; height:491px; left:50%; top:50%; margin-left:-382.5px; margin-top:-245.5px; z-index:1"></div>
<div style="background-color:cadetblue; margin-top: -700px; z-index:2">
    <input type="text" id="chat" maxlength="128">
</div>
<script type="text/javascript">

    const socket = new io();

    document.getElementById('chat').onsubmit = () => {
        socket.emit('chat', document.getElementById('chat').value);
        document.getElementById('chat').value = '';
    };

    let app = new PIXI.Application({width: 765, height: 491});
    let btexture = PIXI.Texture.fromImage('/storage/png/DiscoLocation.png');
    let background = new PIXI.Sprite(btexture);
    let atexture = PIXI.Texture.fromImage('/storage/png/DiscoLocationTop.png');
    let aackground = new PIXI.Sprite(atexture);
    app.stage.addChild(background);
    background.addChild(aackground);
    background.interactive = true;
    background.on('pointerdown', onClick);
    document.getElementById("game").appendChild(app.view);

    const players = new Map();

    socket.on('draw', (usr) => {
        queue.push(() => {
            let character = PIXI.Sprite.fromImage('/storage/skins/' + usr.info.skin + '.png');
            character.interactive = true;
            character.buttonMode = true;
            character.anchor.set(0.5);
            character.x = usr.info.x;
            character.y = usr.info.y;
            background.removeChild(aackground);
            background.addChild(character);
            background.addChild(aackground);
            players.set(usr.uid, character);
        });
    });

    socket.on('chat', (msg) => {
        alert(msg);
    });

    const queue = [];

    app.ticker.add(() => {
        while (queue.length > 0)
            queue.shift()();
    });

    socket.on('move', (usr) => {
        if (!players.has(usr.uid)) location.reload();
        let character = players.get(usr.uid);
        queue.push(() => {
            character.x = usr.x;
            character.y = usr.y;
        })
    });
    socket.on('remove', (usr) => {
        if (!players.has(usr)) location.reload();
        let character = players.get(usr);
        queue.push(() => {
            background.removeChild(character);
            console.log('destroy ' + usr);
            players.delete(usr);
        });
    });

    function onClick() {
        socket.emit('move', {x: app.renderer.plugins.interaction.mouse.global.x, y: app.renderer.plugins.interaction.mouse.global.y});
    }
</script>
</body>
</html>